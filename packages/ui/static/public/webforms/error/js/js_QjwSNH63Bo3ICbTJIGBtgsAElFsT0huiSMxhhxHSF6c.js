/* @license GNU-GPL-2.0-or-later https://www.drupal.org/licensing/faq */
(function($,Drupal,drupalSettings){'use strict';function removeIframeFromUrl(url){return url.replace(/\?iframe=true$/,'').replace(/\?iframe=true&/,'?').replace(/&iframe=true$/,'').replace(/&iframe=true&/,'&');}function prependBaseUrl(url,baseUrl){if(url.indexOf('/')===0&&url.indexOf('//')!==0)return baseUrl+url;}function waitForParentIframe(callback){var interval;function execute(){if(window.parentIFrame){if(interval)window.clearInterval(interval);callback(window.parentIFrame);}}execute();interval=window.setInterval(execute,100);}if(drupalSettings.iframeCommand){var iframeCommands=!Array.isArray(drupalSettings.iframeCommand)?new Array(drupalSettings.iframeCommand):drupalSettings.iframeCommand;if(iframeCommands.length>0){waitForParentIframe(function(parentIFrame){iframeCommands.forEach(function(iframeCommand){var command=iframeCommand;if(command.action==='redirect')command=$.extend(true,{},command,{path:removeIframeFromUrl(command.path)});parentIFrame.sendMessage(command,'*');});});return;}}Drupal.behaviors.silverbackIframeRedirect={attach:function(context){var $messageElements=$('.js-iframe-parent-message',context);var $redirectLinkElement=$('.js-iframe-parent-redirect',context);if($redirectLinkElement.length>0){var redirectLink=$redirectLinkElement.get(0).pathname;waitForParentIframe(function(parentIFrame){parentIFrame.sendMessage({action:'redirect',path:redirectLink,messages:$messageElements.toArray().map(function(el){return el.innerText;})},'*');});}}};waitForParentIframe(function(parentIFrame){parentIFrame.sendMessage({action:'init'},'*');});var updateBaseUrlInLinks=(baseUrl)=>{$('a:visible').each(function(){var $this=$(this);var href=$this.attr('href');if(!href)return true;if($this.hasClass('visually-hidden')||$this.closest('.checkout-pane-review').length||$this.closest('.form-actions').length)return true;href=removeIframeFromUrl(href);href=prependBaseUrl(href,baseUrl);$this.attr('href',href);if($this.attr('target')!=='_blank')$this.attr('target','_parent');return true;});$('body').addClass('silverback-iframe-links-processed');};var injectCssStyles=(styles)=>{var id='silverback-iframe-injected-styles';var el=document.getElementById(id);if(!el){el=document.createElement('style');el.id=id;document.head.appendChild(el);}el.textContent=styles;};window.addEventListener('message',(event)=>{var parsed=parseMessage(event.data);if(!parsed)return;if(parsed.type==='init'){updateBaseUrlInLinks(parsed.baseUrl);if(parsed.injectStyles)injectCssStyles(parsed.injectStyles);}});function parseMessage(message){if(typeof message!=='string')return null;var prefix='[iFrameSizer]message:';if(!message.startsWith(prefix))return null;var parsed=null;try{parsed=JSON.parse(message.substring(prefix.length));}catch(e){return null;}if(typeof parsed!=='object'||typeof parsed.silverbackIframe!=='object'||parsed.silverbackIframe.type!=='init')return null;return parsed.silverbackIframe;}})(jQuery,Drupal,drupalSettings);;
